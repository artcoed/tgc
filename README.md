# Casino Roulette Project

Веб-приложение с рулеткой, интегрированное с Telegram Web Apps. Поддерживает множественные боты с изолированными пользовательскими данными.

## Функциональность

### Рулетка
- Европейская рулетка (числа 0-36)
- Три типа ставок: черное (x2), красное (x2), зеленое (x10)
- Анимация вращения колеса
- Модальные окна результатов (победа/поражение)
- Изменение размера ставки
- Ограничение попыток в день (5 попыток)
- Автоматическое обновление баланса
- Валидация ставок (мин: 10, макс: 95% от баланса)

### Пользователи
- Регистрация через Telegram Web Apps
- Изолированные учетные записи для каждого бота
- Хранение баланса и статистики в базе данных
- Отслеживание попыток и сброс их каждый день
- Уникальная комбинация telegram_id + bot_id для каждого пользователя

## Технологии

### Backend
- Node.js + TypeScript
- tRPC для API
- Kysely для работы с базой данных
- PostgreSQL

### Frontend
- React + TypeScript
- Vite
- tRPC Client
- CSS Modules

## Установка и запуск

### 1. Настройка базы данных
```bash
# Запуск PostgreSQL (если используете Docker)
docker run --name postgres-casino -e POSTGRES_PASSWORD=password -e POSTGRES_DB=casino -p 5432:5432 -d postgres

# Или используйте существующую PostgreSQL
```

### 2. Настройка сервера
```bash
cd server
npm install

# Запуск миграций
npm run migrate

**Примечание:** 
- Миграция автоматически создаст дефолтного бота с ID=1, если он не существует
- Если возникает ошибка с внешним ключом, выполните следующие шаги:
  1. Сначала соберите проект: `npm run build`
  2. Создайте дефолтного бота: `npm run create-default-bot`
  3. Затем запустите миграции: `npm run migrate`

# Сборка TypeScript
npm run build

# Запуск сервера
npm run dev
```

### 3. Настройка клиента
```bash
cd client
npm install

# Запуск в режиме разработки
npm run dev
```

## Структура проекта

```
├── client/                 # React фронтенд
│   ├── src/
│   │   ├── components/     # React компоненты
│   │   ├── contexts/       # React контексты
│   │   ├── hooks/          # Кастомные хуки
│   │   └── trpc.ts         # tRPC клиент
├── server/                 # Node.js бэкенд
│   ├── src/
│   │   ├── db/            # Работа с базой данных
│   │   ├── services/      # Бизнес-логика
│   │   ├── trpc/          # tRPC роутеры и процедуры
│   │   └── server.ts      # HTTP сервер
│   └── migrations/        # Миграции базы данных
└── docker-compose.yml     # Docker конфигурация
```

## API Endpoints

### Рулетка
- `getRouletteInfo` - Получить информацию о рулетке для пользователя (требует telegramId и botId)
- `placeBet` - Сделать ставку в рулетке (требует telegramId и botId)

### Пользователи
- `getCurrentUser` - Получить текущего пользователя (требует telegramId и botId)
- `upsertUserFromTelegram` - Создать/обновить пользователя из Telegram (требует telegramId и botId)
- `completeRegistration` - Завершить регистрацию (требует telegramId и botId)
- `getUserBalance` - Получить баланс пользователя (требует telegramId и botId)
- `getUserStats` - Получить статистику пользователя (требует telegramId и botId)

## База данных

### Таблица users
- Основная информация о пользователе
- Связь с ботом через bot_id (внешний ключ на таблицу bots)
- Баланс и валюта
- Статистика рулетки (победы, поражения, выигрыши)
- Дневные попытки и дата сброса
- Уникальный индекс по (telegram_id, bot_id) для изоляции данных между ботами

## Разработка

### Добавление новых функций
1. Создайте миграцию для изменений БД
2. Обновите типы в `server/src/db/types.ts`
3. Добавьте логику в сервисы
4. Создайте tRPC процедуры
5. Обновите фронтенд компоненты

### Отладка Telegram Web App
- Компонент `DebugInfo` показывает данные Telegram Web App в правом верхнем углу
- Проверьте консоль браузера для дополнительных логов
- Убедитесь, что бот правильно настроен в Telegram Bot API

### Тестирование
```bash
# Тест рулетки
cd server
node test-roulette.js
```

## Лицензия

MIT 